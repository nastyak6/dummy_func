pipeline {
    agent any
    parameters {
        choice(name: 'ACTION', choices: ['backup', 'retrieve'], description: 'Select the action to perform')
        string(name: 'SAMBA_IP', defaultValue: '172.20.0.2', description: 'IP Address of the Samba Server')
        string(name: 'DATA_PATH', defaultValue: '/path/to/local/data', description: 'Local Path to Data to Backup')
        string(name: 'SAMBA_SHARE', defaultValue: 'shared', description: 'Name of the Samba Share')
        string(name: 'SAMBA_USER', defaultValue: 'admin', description: 'Username for Samba Access')
        string(name: 'SAMBA_PASS', defaultValue: 'admin', description: 'Password for Samba Access')
    }
    environment {
        // Define environment variables
        ACTION = "${params.ACTION}"
        SAMBA_IP = "${params.SAMBA_IP}"
        DATA_PATH = "${params.DATA_PATH}"
        SAMBA_SHARE = "${params.SAMBA_SHARE}"
        SAMBA_USER = "${params.SAMBA_USER}"
        SAMBA_PASS = "${params.SAMBA_PASS}"
    }
    stages {
        stage('Checkout Code') {
                steps {
                    checkout scm
                }
            }
      stage('Install smbclient') {
            steps {
                apt install smbclient
            }
        }
        stage('Backup Data') {
            when {
                expression {
                    params.ACTION == 'backup'
                }
            }
            steps {
                script {
                    sh ''
                    TIMESTAMP=$(date +%Y%m%d%H%M%S)
                    smbclient //$SAMBA_IP/$SAMBA_SHARE -U $SAMBA_USER%${SAMBA_PASS} -c "mkdir backup_$TIMESTAMP; prompt OFF; recurse ON; mput DATA_PATH/*"
                    '''
                }
            }
        }
        stage('Revert Data') {
            when {
                expression {
                    params.ACTION == 'retrieve'
                }
            }
            steps {
                script {
                    sh '''
                    smbclient //${params.SAMBA_IP}/${params.SAMBA_SHARE} -U ${params.SAMBA_USER}%${params.SAMBA_PASS} -c "ls" | grep backup_ | sort -r | head -n 1 | awk '{print $1}' > latest_backup.txt
                    LATEST_BACKUP=$(cat latest_backup.txt)
                    smbclient //${params.SAMBA_IP}/${params.SAMBA_SHARE} -U ${params.SAMBA_USER}%${params.SAMBA_PASS} -c "cd $LATEST_BACKUP; prompt OFF; recurse ON; mget *"
                    cp -r $LATEST_BACKUP/* ${params.DATA_PATH}/
                    '''
                }
            }
        }
    }
    post {
        always {
            echo 'Pipeline Completed'
        }
    }
}
